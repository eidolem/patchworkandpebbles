{{!-- "< default" means - insert everything in this file into the {{{body}}} 
of the default.hbs template, containing the blog header/footer. --}}
{{!< default}}

{{!-- Everything inside the #post tags pulls data from the post --}}
{{#post}}
    <article class="{{post_class}}">
    {{!-- If there's a featured image, display it and move the title down --}}
    {{#if image}}
        <div class="row hide-on-small-and-down">
            <div class="col s12 m12 l12 feature-image-wrapper">
                <img class="feature-image" src="{{image}}"></img>
            </div>
        </div>

        <div class="row">
            {{#if tags limit="1"}}
                {{#foreach tags limit="1"}}
                <header class="col s12 m10 l10 offset-m1 offset-l1 post-header move-title-up" data-state={{slug}}>
                {{/foreach}}
            {{else}}
                <header class="col s12 m10 l10 offset-m1 offset-l1 post-header move-title-up">
            {{/if}}
                <h1 class="post-title">{{title}}</h1>
                <section class="post-meta">
                    <div class="col s12 m6 l6">
                        <div class="post-tags">{{tags}}</div>
                    </div>
                    
                    <div class="col s12 m6 l6">
                        <time class="post-date">updated {{date updated_at format="MM.DD.YYYY"}}</time>
                    </div>
                </section>
            </header>
        </div>
    {{!-- If there's no image, don't display it, and don't move the title --}}
    {{else}}
        <div class="row">
            {{#if tags limit="1"}}
                {{#foreach tags limit="1"}}
                <header class="col s12 m10 l10 offset-m1 offset-l1 post-header" data-state={{slug}}>
                {{/foreach}}
            {{else}}
                 <header class="col s12 m10 l10 offset-m1 offset-l1 post-header">
            {{/if}}
                <h1 class="post-title">{{title}}</h1>
                <section class="post-meta">
                    <div class="col s12 m12 l6">
                        <div class="post-tags">{{tags}}</div>
                    </div>
                    
                    <div class="col s12 m12 l6">
                        <time class="right post-date">updated {{date updated_at format="MM.DD.YYYY"}}</time>
                    </div>
                </section>
            </header>
        </div>
    {{/if}}

        <div class="row">
            <section class="col s12 m8 l6 offset-m2 offset-l1 post-content" id="post-content">
                {{content}}
            </section>

            <section class="col s12 l3 offset-l1 hide-on-med-only sidebar-content">
                {{> sidebar}}
            </section>
        </div>

        {{> email-subscribe-popup}}

        {{!-- At end of content --}}
        <div class="row hide-on-small-and-down">
            <div class="col m12 l10 offset-l1">
                {{> related-posts-wide}}
            </div>

            <div class="col m12 l12 hide-on-small-and-down">
                <div class="ad-block my-google-ads">
                    <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-2599762387787801"
                     data-ad-slot="7650868943"
                     data-ad-format="auto"></ins>
                </div>

<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>
            </div>
        </div>

    </article>


    <script>
        $('.my-google-ads').each(function() {
            $.get(ghost.url.api('posts', {limit:'1', filter:"id:{{id}}", include:"tags"})).done(onSuccess);
        });

        function onSuccess(data) {
            var result = data.posts[0].tags[0].slug;
        }
    </script>


    {{!-- In order to grab random posts with the same tags as this post: --}}
    <script>
        // Grab all posts, filtered by tags
        $(document).ready(function () {
            // Get all the posts with these tags, minus the current post id
            $.get(
                ghost.url.api('posts', {limit:'all', filter:"id:{{id}}", include:"tags"})
            ).done(onSuccess)
        });
        
        function onSuccess(data) {
            var result = data.posts[0].tags;
            var tags = $(result).map(function(i, tag) {
                return tag.slug;
            });
            getRelatedPosts(tags);
        }

        function getRelatedPosts(tags) {
            $.get(
                ghost.url.api('posts', {limit: 'all', filter: "tags:[" + $tags.join(',') + "]+id:-{{id}}"})
            ).done(renderRelatedPosts)
        }
 
        function renderRelatedPosts(data) {
            // list-of-posts is on related-posts-card
            var result = $('#list-of-posts');
            // Randomize array
            var sortedPosts = shuffleArray(data.posts);
            // If there's less than 6 posts with this tag, only take the total number of posts 
            if ( sortedPosts.length < 6){
                var displayPosts = sortedPosts.slice(0, sortedPosts.length);
            }
            // Else pull max 6
            else {
                var displayPosts = sortedPosts.slice(0, 6);
            }

            // Insert at bottom of post list
            $.each(displayPosts, function (i, post) {
                result.append(
                    '<div class="row post">'
                        + '<a href="' + post.url + '" class="valign-wrapper">'
                        + '<div class="image col s4 m4 l4" style="background-image: url(' + post.image + ')"></div>'
                        + '<div class="title col s8 m8 l8">' + post.title + '</div>'
                        + '</a></div>'
                );
            });

            // list-of-posts-wide is on related-posts-card-wide
            var result2 = $('#list-of-posts-wide');
            // If there's less than 6 posts with this tag, only pull the total number
            if ( sortedPosts.length < 6){
                var displayPosts2 = sortedPosts.slice(0, sortedPosts.length);
            }
            // Else pull max 6, but don't take the same 6 as was in the sidebar related posts card
            else {
                var displayPosts2 = sortedPosts.slice(7, 13);
            }
            // Insert at end of post list
            $.each(displayPosts2, function (i, post) {
                result2.append(
                        '<a href="' + post.url + '" class="post col m2 l2">'
                        + '<div class="image" style="background-image: url(' + post.image + ')"></div>'
                        + '<div class="title">' + post.title + '</div>'
                        + '</a>'
                );
            });
        }

        // Function to randomize an array
        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
            return array;
        }
    </script>

{{/post}}